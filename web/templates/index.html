<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Text Adventure Game</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 20px;
      }
      #game-log {
        border: 1px solid black;
        padding: 10px;
        height: 350px; /* Reduced height to make room for panels */
        overflow-y: auto;
        margin-bottom: 20px;
        text-align: left;
      }
      button {
        margin: 10px;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
      }
      #reset-button {
        background-color: #ffaa00;
        display: none; /* Hidden by default */
      }
      #inventory-button {
        background-color: #4a89dc; /* Blue color for inventory button */
        color: white;
      }
      #stats-button {
        background-color: #9b59b6; /* Purple color for stats button */
        color: white;
      }
      .item {
        color: #228b22; /* Forest green for items */
      }
      .enemy {
        color: #b22222; /* Firebrick red for enemies */
      }
      .inventory-item {
        color: #9932cc; /* Purple for inventory items */
      }
      .player-stats {
        color: #9b59b6; /* Purple for player stats */
        font-weight: bold;
      }
      .stats-value {
        color: #3498db; /* Blue for the stat values */
      }
      #item-actions {
        margin: 10px 0;
        padding: 10px;
        border-top: 1px dashed #ccc;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
      }
      .pickup-button {
        background-color: #4caf50;
        color: white;
        margin: 5px;
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .pickup-button:hover {
        background-color: #45a049;
      }
      .success-message {
        color: #4caf50;
        font-weight: bold;
      }
      .error-message {
        color: #f44336;
        font-weight: bold;
      }

      /* Panel Styles */
      .info-panel {
        display: none; /* Hidden by default */
        border: 1px solid #ddd;
        border-radius: 8px;
        margin: 0 auto 20px auto;
        padding: 15px;
        width: 90%;
        max-width: 800px;
        text-align: left;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        animation: panelFade 0.3s ease-in-out;
      }

      @keyframes panelFade {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      #stats-panel {
        background-color: #f8f3ff; /* Light purple background */
        border-left: 5px solid #9b59b6;
      }

      #inventory-panel {
        background-color: #f3f8ff; /* Light blue background */
        border-left: 5px solid #4a89dc;
      }

      .panel-title {
        margin-top: 0;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
        font-size: 18px;
        text-align: center;
      }

      .stats-title {
        color: #9b59b6;
      }

      .inventory-title {
        color: #4a89dc;
      }

      .panel-content ul {
        list-style-type: none;
        padding: 0;
      }

      .panel-content li {
        margin: 8px 0;
        padding: 8px;
        border-bottom: 1px solid #eee;
      }

      .stat-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 15px;
        border-bottom: 1px solid #eee;
      }

      .stat-label {
        font-weight: bold;
        color: #9b59b6;
      }

      .stat-value {
        font-weight: bold;
        color: #3498db;
      }

      .empty-message {
        color: #95a5a6;
        font-style: italic;
        text-align: center;
        padding: 15px;
      }
    </style>
  </head>
  <body>
    <h1>Text Adventure Game</h1>

    <div id="game-log">
      <p>
        Welcome to the Text Adventure Game! Click "Enter Next Room" to begin
        your journey.
      </p>
    </div>

    <!-- Stats Panel (Hidden by default) -->
    <div id="stats-panel" class="info-panel">
      <h3 class="panel-title stats-title">Player Stats</h3>
      <div id="stats-content" class="panel-content"></div>
    </div>

    <!-- Inventory Panel (Hidden by default) -->
    <div id="inventory-panel" class="info-panel">
      <h3 class="panel-title inventory-title">Your Inventory</h3>
      <div id="inventory-content" class="panel-content"></div>
    </div>

    <div id="item-actions"></div>

    <div id="game-actions">
      <button id="next-room-btn" onclick="enterRoom()">Enter Next Room</button>
      <button id="inventory-button" onclick="toggleInventory()">
        View Inventory
      </button>
      <button id="stats-button" onclick="togglePlayerStats()">
        View Stats
      </button>
      <button id="reset-button" onclick="resetGame()" style="display: none">
        Reset Game
      </button>
    </div>

    <script>
      let player_id = 1;
      let current_room_id = 0;
      let room_items = [];

      function logMessage(message, className = "") {
        if (className) {
          $("#game-log").append(`<p class="${className}">${message}</p>`);
        } else {
          $("#game-log").append(`<p>${message}</p>`);
        }
        // Auto-scroll to bottom
        $("#game-log").scrollTop($("#game-log")[0].scrollHeight);
      }

      function togglePanel(panelId) {
        // Hide all panels first
        $(".info-panel").hide();

        // Get the panel element
        const panel = $(`#${panelId}`);

        // Toggle the panel
        panel.toggle();

        // If panel is visible, scroll to it
        if (panel.is(":visible")) {
          $("html, body").animate(
            {
              scrollTop: panel.offset().top - 20,
            },
            300
          );
        }
      }

      function createItemButtons(items, room_id) {
        // Clear previous buttons
        $("#item-actions").empty();

        // If no items, don't show anything
        if (!items || items.length === 0) {
          return;
        }

        // Create buttons for each item
        items.forEach((item) => {
          const button = $(`<button class="pickup-button" 
                           data-item-id="${item.id}" 
                           data-room-id="${room_id}" 
                           data-item-name="${item.name}">
                           Pick up ${item.name}</button>`);

          button.click(function () {
            const itemId = $(this).data("item-id");
            const roomId = $(this).data("room-id");
            const itemName = $(this).data("item-name");
            pickUpItem(roomId, itemId, itemName, this);
          });

          $("#item-actions").append(button);
        });
      }

      function pickUpItem(roomId, itemId, itemName, buttonElement) {
        $.ajax({
          url: "/pick_up_item",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({
            room_id: roomId,
            item_id: itemId,
          }),
          success: function (response) {
            logMessage(`You picked up the ${itemName}!`, "success-message");

            // Remove the button since the item is now picked up
            $(buttonElement).remove();

            // Remove the item from the room_items array
            room_items = room_items.filter((item) => item.id !== itemId);

            // If all items are picked up, maybe show a message
            if (room_items.length === 0) {
              $("#item-actions").empty();
            }
          },
          error: function (xhr) {
            let errorMsg = "Failed to pick up item";
            try {
              errorMsg = JSON.parse(xhr.responseText).error || errorMsg;
            } catch (e) {}

            logMessage(
              `Failed to pick up ${itemName}: ${errorMsg}`,
              "error-message"
            );
          },
        });
      }

      function enterRoom() {
        // Hide any open panels when entering a new room
        $(".info-panel").hide();

        $.ajax({
          url: "/enter_room",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({}),
          success: function (response) {
            if (response.end_of_game) {
              // End of game reached
              logMessage("------------------------------");
              logMessage(response.message);
              logMessage("You've reached the end of the game!");

              // Show reset button, hide next room button
              $("#reset-button").show();
              $("#next-room-btn").hide();
              $("#item-actions").empty();
            } else {
              // Normal room entry
              logMessage("------------------------------");
              logMessage(
                `Room ${response.player_current_room}: ${response.room_name}`
              );
              logMessage(response.description);

              // Update current room ID
              current_room_id = response.player_current_room;

              // Store room items for later reference
              room_items = response.items || [];

              // Display items in the room
              if (response.items && response.items.length > 0) {
                logMessage("Items in this room:", "item");
                response.items.forEach((item) => {
                  logMessage(`- ${item.name}: ${item.description}`, "item");
                });

                // Create pickup buttons for the items
                createItemButtons(response.items, current_room_id);
              } else {
                // Clear item buttons if no items in the room
                $("#item-actions").empty();
              }

              // Display enemies in the room
              if (response.enemies && response.enemies.length > 0) {
                logMessage("Enemies in this room:", "enemy");
                response.enemies.forEach((enemy) => {
                  logMessage(`- ${enemy.name}: ${enemy.description}`, "enemy");
                });
              }

              if (
                (!response.items || response.items.length === 0) &&
                (!response.enemies || response.enemies.length === 0)
              ) {
                logMessage("This room is empty.");
              }
            }
          },
          error: function (xhr) {
            // Get the response data
            let response = {};
            try {
              response = JSON.parse(xhr.responseText);
            } catch (e) {
              response = { error: "An unknown error occurred" };
            }

            // Log appropriate message based on status and response
            logMessage("------------------------------");

            // Special handling for locked doors (403 status with door_locked flag)
            if (xhr.status === 403 && response.door_locked) {
              logMessage(
                response.error || "This door is locked!",
                "error-message"
              );
              logMessage(
                "You need to find a Lockpick to proceed!",
                "error-message"
              );
              logMessage("------------------------------");
              return; // Exit early
            }
            // Special handling for out of bounds rooms (end of game)
            else if (response.end_of_game) {
              logMessage(
                response.message || "You've reached the end of the game!"
              );

              // Show reset button, hide next room button
              $("#reset-button").show();
              $("#next-room-btn").hide();
              $("#item-actions").empty();
            }
            // Handle other errors
            else {
              logMessage(
                `Error: ${response.error || "Could not enter the room"}`,
                "error-message"
              );
              logMessage("------------------------------");
            }
          },
        });
      }

      function resetGame() {
        // Hide any open panels when resetting the game
        $(".info-panel").hide();

        $.ajax({
          url: "/enter_room",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({ target_room_id: 0 }),
          success: function (response) {
            logMessage("------------------------------");
            logMessage("Game reset! Starting over from the beginning.");
            logMessage(
              `Room ${response.player_current_room}: ${response.room_name}`
            );
            logMessage(response.description);

            // Update current room ID
            current_room_id = response.player_current_room;

            // Store room items for later reference
            room_items = response.items || [];

            // Display items and enemies in the starting room
            if (response.items && response.items.length > 0) {
              logMessage("Items in this room:", "item");
              response.items.forEach((item) => {
                logMessage(`- ${item.name}: ${item.description}`, "item");
              });

              // Create pickup buttons for the items
              createItemButtons(response.items, current_room_id);
            } else {
              // Clear item buttons if no items in the room
              $("#item-actions").empty();
            }

            if (response.enemies && response.enemies.length > 0) {
              logMessage("Enemies in this room:", "enemy");
              response.enemies.forEach((enemy) => {
                logMessage(`- ${enemy.name}: ${enemy.description}`, "enemy");
              });
            }

            // Hide reset button, show next room button
            $("#reset-button").hide();
            $("#next-room-btn").show();
          },
          error: function (xhr) {
            let errorMsg = "Failed to reset the game";
            try {
              errorMsg = JSON.parse(xhr.responseText).error || errorMsg;
            } catch (e) {}

            logMessage("------------------------------");
            logMessage(errorMsg);
          },
        });
      }

      function toggleInventory() {
        // First check if inventory panel is already visible
        if ($("#inventory-panel").is(":visible")) {
          // If it's visible, just hide it
          $("#inventory-panel").hide();
          return;
        }

        // Otherwise fetch inventory data and show the panel
        $.ajax({
          url: "/view_inventory",
          type: "GET",
          success: function (response) {
            const items = response.items || [];
            const inventoryContent =
              document.getElementById("inventory-content");

            // Clear previous content
            inventoryContent.innerHTML = "";

            if (items.length === 0) {
              // Display empty inventory message
              inventoryContent.innerHTML =
                "<div class='empty-message'>Your inventory is empty.</div>";
            } else {
              // Create list of items
              const itemList = document.createElement("ul");

              items.forEach((item) => {
                const listItem = document.createElement("li");
                listItem.innerHTML = `<strong>${item.name}</strong>: ${item.description}`;
                itemList.appendChild(listItem);
              });

              inventoryContent.appendChild(itemList);
            }

            // Show the inventory panel, hide stats panel
            togglePanel("inventory-panel");
          },
          error: function (xhr) {
            let errorMsg = "Failed to retrieve inventory";
            try {
              errorMsg = JSON.parse(xhr.responseText).error || errorMsg;
            } catch (e) {}

            // Display error in game log instead
            logMessage("------------------------------");
            logMessage(`Error: ${errorMsg}`, "error-message");
            logMessage("------------------------------");
          },
        });
      }

      function togglePlayerStats() {
        // First check if stats panel is already visible
        if ($("#stats-panel").is(":visible")) {
          // If it's visible, just hide it
          $("#stats-panel").hide();
          return;
        }

        // Otherwise fetch stats data and show the panel
        $.ajax({
          url: "/player_stats",
          type: "GET",
          success: function (response) {
            const statsContent = document.getElementById("stats-content");

            // Clear previous content
            statsContent.innerHTML = "";

            // Create stats display with rows
            const statsContainer = document.createElement("div");

            // Create a row for each stat
            const stats = [
              { label: "Name", value: response.name || "Unknown" },
              { label: "Class", value: response.character_class || "Unknown" },
              { label: "Health", value: response.health || 0 },
              { label: "Damage", value: response.damage || 0 },
              { label: "Current Room", value: response.room_id || 0 },
            ];

            stats.forEach((stat) => {
              const row = document.createElement("div");
              row.className = "stat-row";
              row.innerHTML = `
                <div class="stat-label">${stat.label}:</div>
                <div class="stat-value">${stat.value}</div>
              `;
              statsContainer.appendChild(row);
            });

            statsContent.appendChild(statsContainer);

            // Show the stats panel, hide inventory panel
            togglePanel("stats-panel");
          },
          error: function (xhr) {
            let errorMsg = "Failed to retrieve player stats";
            try {
              errorMsg = JSON.parse(xhr.responseText).error || errorMsg;
            } catch (e) {}

            // Display error in game log instead
            logMessage("------------------------------");
            logMessage(`Error: ${errorMsg}`, "error-message");
            logMessage("------------------------------");
          },
        });
      }
    </script>
  </body>
</html>
