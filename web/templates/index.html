<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Text Adventure Game</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 20px;
      }
      #game-log {
        border: 1px solid black;
        padding: 10px;
        height: 450px; /* Increased height from 300px to 450px */
        overflow-y: auto;
        margin-bottom: 20px;
        text-align: left;
      }
      button {
        margin: 10px;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
      }
      #reset-button {
        background-color: #ffaa00;
        display: none; /* Hidden by default */
      }
      #inventory-button {
        background-color: #4a89dc; /* Blue color for inventory button */
        color: white;
      }
      .item {
        color: #228b22; /* Forest green for items */
      }
      .enemy {
        color: #b22222; /* Firebrick red for enemies */
      }
      .inventory-item {
        color: #9932cc; /* Purple for inventory items */
      }
      #item-actions {
        margin: 10px 0;
        padding: 10px;
        border-top: 1px dashed #ccc;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
      }
      .pickup-button {
        background-color: #4caf50;
        color: white;
        margin: 5px;
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .pickup-button:hover {
        background-color: #45a049;
      }
      .success-message {
        color: #4caf50;
        font-weight: bold;
      }
      .error-message {
        color: #f44336;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Text Adventure Game</h1>

    <div id="game-log">
      <p>
        Welcome to the Text Adventure Game! Click "Enter Next Room" to begin
        your journey.
      </p>
    </div>

    <div id="item-actions"></div>

    <div id="game-actions">
      <button id="next-room-btn" onclick="enterRoom()">Enter Next Room</button>
      <button id="inventory-button" onclick="viewInventory()">View Inventory</button>
      <button id="reset-button" onclick="resetGame()" style="display: none">
        Reset Game
      </button>
    </div>

    <script>
      let player_id = 1;
      let current_room_id = 0;
      let room_items = [];

      function logMessage(message, className = "") {
        if (className) {
          $("#game-log").append(`<p class="${className}">${message}</p>`);
        } else {
          $("#game-log").append(`<p>${message}</p>`);
        }
        // Auto-scroll to bottom
        $("#game-log").scrollTop($("#game-log")[0].scrollHeight);
      }

      function createItemButtons(items, room_id) {
        // Clear previous buttons
        $("#item-actions").empty();

        // If no items, don't show anything
        if (!items || items.length === 0) {
          return;
        }

        // Create buttons for each item
        items.forEach((item) => {
          const button = $(`<button class="pickup-button" 
                           data-item-id="${item.id}" 
                           data-room-id="${room_id}" 
                           data-item-name="${item.name}">
                           Pick up ${item.name}</button>`);

          button.click(function () {
            const itemId = $(this).data("item-id");
            const roomId = $(this).data("room-id");
            const itemName = $(this).data("item-name");
            pickUpItem(roomId, itemId, itemName, this);
          });

          $("#item-actions").append(button);
        });
      }

      function pickUpItem(roomId, itemId, itemName, buttonElement) {
        $.ajax({
          url: "/pick_up_item",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({
            room_id: roomId,
            item_id: itemId,
          }),
          success: function (response) {
            logMessage(`You picked up the ${itemName}!`, "success-message");

            // Remove the button since the item is now picked up
            $(buttonElement).remove();

            // Remove the item from the room_items array
            room_items = room_items.filter((item) => item.id !== itemId);

            // If all items are picked up, maybe show a message
            if (room_items.length === 0) {
              $("#item-actions").empty();
            }
          },
          error: function (xhr) {
            let errorMsg = "Failed to pick up item";
            try {
              errorMsg = JSON.parse(xhr.responseText).error || errorMsg;
            } catch (e) {}

            logMessage(
              `Failed to pick up ${itemName}: ${errorMsg}`,
              "error-message"
            );
          },
        });
      }

      function enterRoom() {
        $.ajax({
          url: "/enter_room",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({}),
          success: function (response) {
            if (response.end_of_game) {
              // End of game reached
              logMessage("------------------------------");
              logMessage(response.message);
              logMessage("You've reached the end of the game!");

              // Show reset button, hide next room button
              $("#reset-button").show();
              $("#next-room-btn").hide();
              $("#item-actions").empty();
            } else {
              // Normal room entry
              logMessage("------------------------------");
              logMessage(
                `Room ${response.player_current_room}: ${response.room_name}`
              );
              logMessage(response.description);

              // Update current room ID
              current_room_id = response.player_current_room;

              // Store room items for later reference
              room_items = response.items || [];

              // Display items in the room
              if (response.items && response.items.length > 0) {
                logMessage("Items in this room:", "item");
                response.items.forEach((item) => {
                  logMessage(`- ${item.name}: ${item.description}`, "item");
                });

                // Create pickup buttons for the items
                createItemButtons(response.items, current_room_id);
              } else {
                // Clear item buttons if no items in the room
                $("#item-actions").empty();
              }

              // Display enemies in the room
              if (response.enemies && response.enemies.length > 0) {
                logMessage("Enemies in this room:", "enemy");
                response.enemies.forEach((enemy) => {
                  logMessage(`- ${enemy.name}: ${enemy.description}`, "enemy");
                });
              }

              if (
                (!response.items || response.items.length === 0) &&
                (!response.enemies || response.enemies.length === 0)
              ) {
                logMessage("This room is empty.");
              }
            }
          },
          error: function (xhr) {
            // Get the response data
            let response = {};
            try {
              response = JSON.parse(xhr.responseText);
            } catch (e) {
              response = { error: "An unknown error occurred" };
            }

            // Log appropriate message based on status and response
            logMessage("------------------------------");
            
            // Special handling for locked doors (403 status with door_locked flag)
            if (xhr.status === 403 && response.door_locked) {
              logMessage(response.error || "This door is locked!", "error-message");
              logMessage("You need to find a Lockpick to proceed!", "error-message");
              logMessage("------------------------------");
              return; // Exit early
            } 
            // Special handling for out of bounds rooms (end of game)
            else if (response.end_of_game) {
              logMessage(response.message || "You've reached the end of the game!");
              
              // Show reset button, hide next room button
              $("#reset-button").show();
              $("#next-room-btn").hide();
              $("#item-actions").empty();
            }
            // Handle other errors
            else {
              logMessage(`Error: ${response.error || "Could not enter the room"}`, "error-message");
              logMessage("------------------------------");
            }
          },
        });
      }

      function resetGame() {
        $.ajax({
          url: "/enter_room",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({ target_room_id: 0 }),
          success: function (response) {
            logMessage("------------------------------");
            logMessage("Game reset! Starting over from the beginning.");
            logMessage(
              `Room ${response.player_current_room}: ${response.room_name}`
            );
            logMessage(response.description);

            // Update current room ID
            current_room_id = response.player_current_room;

            // Store room items for later reference
            room_items = response.items || [];

            // Display items and enemies in the starting room
            if (response.items && response.items.length > 0) {
              logMessage("Items in this room:", "item");
              response.items.forEach((item) => {
                logMessage(`- ${item.name}: ${item.description}`, "item");
              });

              // Create pickup buttons for the items
              createItemButtons(response.items, current_room_id);
            } else {
              // Clear item buttons if no items in the room
              $("#item-actions").empty();
            }

            if (response.enemies && response.enemies.length > 0) {
              logMessage("Enemies in this room:", "enemy");
              response.enemies.forEach((enemy) => {
                logMessage(`- ${enemy.name}: ${enemy.description}`, "enemy");
              });
            }

            // Hide reset button, show next room button
            $("#reset-button").hide();
            $("#next-room-btn").show();
          },
          error: function (xhr) {
            let errorMsg = "Failed to reset the game";
            try {
              errorMsg = JSON.parse(xhr.responseText).error || errorMsg;
            } catch (e) {}

            logMessage("------------------------------");
            logMessage(errorMsg);
          },
        });
      }

      function viewInventory() {
        $.ajax({
          url: "/view_inventory",
          type: "GET",
          success: function (response) {
            logMessage("------------------------------");
            logMessage("Your Inventory:", "inventory-item");
            
            const items = response.items || [];
            
            if (items.length === 0) {
              logMessage("Your inventory is empty.", "inventory-item");
            } else {
              // Each item already has name and description, no need for additional fetches
              items.forEach(item => {
                logMessage(`- ${item.name}: ${item.description}`, "inventory-item");
              });
            }
            logMessage("------------------------------");
          },
          error: function (xhr) {
            let errorMsg = "Failed to retrieve inventory";
            try {
              errorMsg = JSON.parse(xhr.responseText).error || errorMsg;
            } catch (e) {}
            
            logMessage("------------------------------");
            logMessage(`Error: ${errorMsg}`, "error-message");
            logMessage("------------------------------");
          }
        });
      }
    </script>
  </body>
</html>
